# Pulse-Adjoint #

This repo contains the code that is based on the following paper: (link to paper)

A cardiac computational model is constrained using clinical measurements such as pressure, volume and regional strain. The problem is formulated as a PDE-constrained optimisation problem where the objective functional represents the misfit between measured and simulated data. There are two phases; passive and active. In the passive phase the material parameters are the control parameters, and in the active phase the contraction parameter is the control parameter. The control parameters can be scalar or spatially resolved. The problem is solved using a gradient based optimization algorithm where the gradient is provided by solving the adjoint system.

## Requirements ##
In order to simply run the code you need
```
* FEniCS version 2016.1
  -- http://fenicsproject.org
* Dolfin-Adjoint version 2016.1
  -- http://www.dolfin-adjoint.org/en/latest/download/index.html
```

### Optional ###
To get the most out of it you also need
```
* yaml
  -- Used for storing parameters
  -- pip install pyyaml
* patient_data (should make a basic version part of the repo)
  -- Used for loading patient data in the correct format
  -- This repo also contains some test data
  -- git clone git@bitbucket.org:finsberg/patient_data.git
  -- Ask Henrik for access
* mesh_generation
  -- Used for loading the meshes in patient_data
  -- git clone git@bitbucket.org:finsberg/mesh_generation.git
* pulse_adjoint_post
  -- Used for posprocessing
  -- git clone git@bitbucket.org:finsberg/pulse_adjoint_post.git
* IPOPT and pyipot
  -- Interior Point Optimization algorithm
  -- This is the best available open-source optimisation algorithm
  -- see http://www.dolfin-adjoint.org/en/latest/download/index.html#optional-dependencies
  -- Currently not working in parallell (Fix later)

```

## Structure of the repo ##
```
* pulse_adjoint
  -- The main code
* demo
  -- Contains two demos. One for using the mechanics solver, and one for using the optimization pipeline.
* test
  -- Contains some tests to check that everything is computed correctly. 
     There is also a documented which explains the setup for method of manufactured solutions. 
* doc
  -- Contains documentation generated by sphinx. 
     Go into this folder and type `make html` to generate html files containing the documentation. 
     More documentation will by provided later. 
```
## How to adjust the setup ##

To setup the optimization you want to change the parameters 
in setup_optimization.py. Here you should specify the paths to the data
you are using and what type of parameters/setups you want to use. 

The main script to run is run_full_optimization.py which optimizes both
material parameters for the passive phase and contraction parameters for the
active phase for all points in your data sets. 
This script calls the functions from run_optimization.py where the different phases
are separated.

In optimization_targets.py you can see what types of targets you can choose for the optimization.
These should also serve as a good template for implementing your own targets. 

There are two important classes to be aware of. One is the HeartProblem class 
located in heart_problem.py which is used as a communicator with the solver.
The other is the ForwardRunner class which is used to run the forward problem
and is located in forward_runner.py

The solver in lvsolver.py together with the material and compressibility scripts
works independently. For an easy demo se tests/test_solver.py

### Other features ###

* One can generate synthetic data and test the optimization using this data
as input. To do so run the script synthetic_data.py
* For postprocessing of the data have a look at pulse_adjoint_post.

## License ##
PULSE-ADJOINT is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

PULSE-ADJOINT is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with PULSE-ADJOINT. If not, see <http://www.gnu.org/licenses/>.

## Contributors ##
* Henrik Finsberg (henriknf@simula.no)
* Gabriel Balaban (gabrib@simula.no)